name: CI (light)

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  test:
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh
    env:
      POWERSHELL_TELEMETRY_OPTOUT: 1
    steps:
      - uses: actions/checkout@v4

      - name: Set execution policy
        run: Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass -Force

      - name: Install tools
        run: |
          Set-PSRepository PSGallery -InstallationPolicy Trusted -ErrorAction SilentlyContinue
          Install-Module PSScriptAnalyzer -Scope CurrentUser -Force -AllowClobber
          Install-Module Pester -Scope CurrentUser -Force -SkipPublisherCheck

      - name: Run ScriptAnalyzer
        run: Invoke-ScriptAnalyzer -Path src -Recurse -Settings ./tools/PSScriptAnalyzerSettings.psd1 -Severity Error

      - name: Run Pester tests
        run: Invoke-Pester -CI -Output Detailed